<!DOCTYPE html>
<html>
<head>
    <title>资料填写</title>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
    
    <meta content="application/xhtml+xml;charset=UTF-8" http-equiv="Content-Type">
    <meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
    <meta content="no-cache" http-equiv="pragma">
    <meta content="0" http-equiv="expires">
    <meta content="telephone=no, address=no" name="format-detection">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link href="css/s_common.css?v=20170226" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/s_common.js"></script>
</head>

<body>

<!-- 资料填写第二步 -->
<div class="step2-page">
      <img class="stepimg" src="./images/step2.png"/>
    
    <div class="cs-info-main">
        <div class="cs-dt-main">
            <div class="cs-stu-item-tr">个人照片<span class="req">*</span>：</div>
            <div class="cs-picdiv">
                <div id="idPic1" class="css-addimg-bt" >请上传申请者本人正面免冠彩色照片</div>
                <input bindid="idPic1" id="idPic1input" type="file" class="imginput" accept="image/*;capture=camera"  style="display: none;" />
		        <div id="preview-idPic1" class="pre-img" style="display: none;"><img class="css-addimg-img" id="imgidPic1" src=""/></div>
            </div>
            <div class="clear"></div>
            
            <div class="cs-box cs-item-remark">
                <div class="cs-box-flex1">
                   <!-- <div class="cs-item-remark-tl">右图示例</div>-->
                    <div>
                        <ul>
	                        <li>照片内容清晰，不能有歪、斜、模糊不清、面部信息缺失扭曲等；</li>
	                        <li>本照片将打印在学生证上，以1寸普通数码彩色登记照（电子稿）为佳，谨慎上传生活照，禁止上传艺术照。</li>
	                    </ul>
                    </div>
                </div>
                <div class="cs-user-picture"><img alt="" src="https://whtpay.whbaw.cn/paytest/images/ex_stu_logo.png" /></div>
            </div>
            <div class="clear"></div>
            
            <div class="cs-stu-item-tr">身份证明文件<span class="req">*</span>：</div>
            <div class="cs-picdiv">
                <div id="idPic2" class="css-addimg-bt" >请上传身份证正面 或 户口本首页</div>
                <input bindid="idPic2" id="idPic2input" type="file" class="imginput" accept="image/*;capture=camera"  style="display: none;" />
                <div id="preview-idPic2" class="pre-img" style="display: none;"><img class="css-addimg-img" id="imgidPic2" src="" style="min-height: 85px; width: auto;" /><div id="rek_idPic2" class="css-sf-rek" >仅用于申请学生卡</div></div>
            </div>
            
            <div class="cs-picdiv" style="margin-top: 10px;">
                <div id="idPic3" class="css-addimg-bt" >请上传身份证反面 或 户口本申请者所在页</div>
                <input bindid="idPic3" id="idPic3input" type="file" class="imginput" accept="image/*;capture=camera"  style="display: none;" />
                <div id="preview-idPic3" class="pre-img" style="display: none;"><img class="css-addimg-img" id="imgidPic3" src="" style="min-height: 85px; width: auto;" /><div id="rek_idPic3" class="css-sf-rek" >仅用于申请学生卡</div></div>
            </div>
            
            <div class="clear"></div>
            <div class="cs-box cs-item-remark">
                 <ul>
                     <li>照片清晰，无反光，人像和数字清晰可见，不得有模糊、篡改、证件缺失不全等。</li>
                 </ul>
            </div>
            <div class="clear"></div>
            
            <div class="cs-stu-item-tr">学生证明文件<span class="req">*</span>：<span class="note">(非兰州本地户口请填写此项)</span></div>
            <div class="cs-picdiv">
                <div id="idPic4" class="css-addimg-bt" >请上传学生证正面 或 其他学生身份证明文件</div>
                <input bindid="idPic4" id="idPic4input" type="file" class="imginput" accept="image/*;capture=camera"  style="display: none;" />
                <div id="preview-idPic4" class="pre-img" style="display: none;"><img class="css-addimg-img" id="imgidPic4" src="" style="min-height: 85px; width: auto;"  /><div id="rek_idPic4" class="css-sf-rek" >仅用于申请武汉通学生卡</div></div>
            </div>
        
            <div class="clear"></div>
            <div class="cs-box cs-item-remark">
                 <ul>
                     <li>照片清晰，无反光，人像和数字清晰可见，不得有模糊、篡改、证件缺失不全等。</li>
                 </ul>
            </div>
            
            <div class="agency">
            	<span class = 'spanTitle'>代办人信息</span>
            	<ul>
            		<li><span>姓名</span><input class="agencyName" placeholder="请输入代办人姓名"></li>
            		<li><span>家庭住址</span><input class="agencyAddress" placeholder="请输入代办人家庭住址"></li>
            		<li><span>联系电话</span><input class="agencyPhone" placeholder="请输入代办人联系电话"></li>
            		<li><span>与学生关系</span><input class="agencyRelationship" placeholder="请输入代办人与学生关系"></li>
            	</ul>
            </div>
           
       </div>
       
    </div>
    
    
    <div class="cs-dt-footer"><div class="cs-btn-next">下一步</div></div>
    
</div>
<div class="clear" style="height: 1rem;">&nbsp;</div>


<script type="text/javascript">
document.addEventListener('DOMContentLoaded', init, false);
var _identifid = 'ohM8Fj3ODToHzSUJaBvhRs5tuvK0';
if (_identifid == "" || _identifid =="undefined") {
	location.href = 'https://whtpay.whbaw.cn/paytest/stucard_index.html';
}
function init() {
    var u1 = new UploadPic();
    u1.init({
        input : document.querySelector('#idPic1input'),
        callback : function(base64) {
        	var _bgid = this.bgid;
        	$('#imgidPic1').attr("src", base64);
        	$("#"+_bgid).hide();
            $("#preview-idPic1").show();
            var value = base64; 
            var valuearr = value.split("base64,"); 
            localStorage.setItem("stu_img_suffix_" +_bgid, valuearr[0]);
            localStorage.setItem("stu_img_" +_bgid, valuearr[1]);
        },
        loading : function() {

        }
    });
    
    var u2 = new UploadPic();
    u2.init({  
        input : document.querySelector('#idPic2input'),
        callback : function(base64) {
            //this.fileType
        	var _bgid = this.bgid;
        	$('#imgidPic2').attr("src", base64);
        	$("#"+_bgid).hide();
        	$("#rek_"+_bgid).show();
        	
            $("#preview-idPic2").show();
            var value = base64; 
            var valuearr = value.split("base64,"); 
            localStorage.setItem("stu_img_suffix_" +_bgid, valuearr[0]);
            localStorage.setItem("stu_img_" +_bgid, valuearr[1]);
        },
        loading : function() {

        }
    });
    
    var u3 = new UploadPic();
    u3.init({
        input : document.querySelector('#idPic3input'),
        callback : function(base64) {
            //this.fileType
        	var _bgid = this.bgid;
        	$('#imgidPic3').attr("src", base64);
        	$("#"+_bgid).hide();
        	$("#rek_"+_bgid).show();
            $("#preview-idPic3").show();
            var value = base64; 
            var valuearr = value.split("base64,"); 
            localStorage.setItem("stu_img_suffix_" +_bgid, valuearr[0]);
            localStorage.setItem("stu_img_" +_bgid, valuearr[1]);
        },
        loading : function() {

        }
    });
    
    var u4 = new UploadPic();
    u4.init({
        input : document.querySelector('#idPic4input'),
        callback : function(base64) {
            //this.fileType
        	var _bgid = this.bgid;
            $('#imgidPic4').attr("src", base64);
            $("#"+_bgid).hide();
			$("#rek_"+_bgid).show();
            $("#preview-idPic4").show();
            var value = base64; 
            var valuearr = value.split("base64,"); 
            localStorage.setItem("stu_img_suffix_" +_bgid, valuearr[0]);
            localStorage.setItem("stu_img_" +_bgid, valuearr[1]);
        },
        loading : function() {

        }
    });
}

function UploadPic() {
    this.sw = 0;
    this.sh = 0;
    this.tw = 0;
    this.th = 0;
    this.scale = 0;
    this.maxWidth = 0;
    this.bgid = "";
    this.maxHeight = 0;
    this.maxSize = 0;
    this.fileSize = 0;
    this.fileDate = null;
    this.fileType = '';
    this.fileName = '';
    this.input = null;
    this.canvas = null;
    this.mime = {};
    this.type = '';
    this.callback = function() {
    };
    this.loading = function() {
    };
}

UploadPic.prototype.init = function(options) {
    this.maxWidth = options.maxWidth || 358;
    this.maxHeight = options.maxHeight || 441;
    this.maxSize = options.maxSize || 3 * 1024 * 1024;
    this.input = options.input;
     
    this.mime = {
        'png' : 'image/png',
        'jpg' : 'image/jpeg',
        'jpeg' : 'image/jpeg',
        'bmp' : 'image/bmp'
    };
    this.callback = options.callback || function() {
    };
    this.loading = options.loading || function() {
    };
    this._addEvent();
};

/**
 * @description 绑定事件
 * @param {Object}
 *            elm 元素
 * @param {Function}
 *            fn 绑定函数
 */
UploadPic.prototype._addEvent = function() {
    var _this = this;
	
    function tmpSelectFile(ev) {
        _this._handelSelectFile(ev);
    }

    this.input.addEventListener('change', tmpSelectFile, false);
};

/**
 * @description 绑定事件
 * @param {Object}
 *            elm 元素
 * @param {Function}
 *            fn 绑定函数
 */
UploadPic.prototype._handelSelectFile = function(ev) {
    var file = ev.target.files[0];

    this.type = file.type;
    this.bgid = $(ev.target).attr("bindid");
    
    // 如果没有文件类型，则通过后缀名判断（解决微信及360浏览器无法获取图片类型问题）
    if (!this.type) {
        this.type = this.mime[file.name.match(/\.([^\.]+)$/i)[1]];
    }

    if (!/image.(png|jpg|jpeg|bmp)/.test(this.type)) {
        alert('选择的文件类型不是图片');
        return;
    }

    if (file.size > this.maxSize) {
        alert('选择文件大于' + this.maxSize / 1024 / 1024 + 'M，请重新选择');
        return;
    }

    this.fileName = file.name;
    this.fileSize = file.size;
    this.fileType = this.type;
    this.fileDate = file.lastModifiedDate;

    this._readImage(file);
};

/**
 * @description 读取图片文件
 * @param {Object}
 *            image 图片文件
 */
UploadPic.prototype._readImage = function(file) {
    var _this = this;

    function tmpCreateImage(uri) {
        _this._createImage(uri);
    }

    this.loading();

    this._getURI(file, tmpCreateImage);
};

/**
 * @description 通过文件获得URI
 * @param {Object}
 *            file 文件
 * @param {Function}
 *            callback 回调函数，返回文件对应URI return {Bool} 返回false
 */
UploadPic.prototype._getURI = function(file, callback) {
    var reader = new FileReader();
    var _this = this;

    function tmpLoad() {
        // 头不带图片格式，需填写格式
        var re = /^data:base64,/;
        var ret = this.result + '';

        if (re.test(ret))
            ret = ret.replace(re, 'data:' + _this.mime[_this.fileType]
                    + ';base64,');

        callback && callback(ret);
    }

    reader.onload = tmpLoad;

    reader.readAsDataURL(file);

    return false;
};

/**
 * @description 创建图片
 * @param {Object}
 *            image 图片文件
 */
UploadPic.prototype._createImage = function(uri) {
    var img = new Image();
    var _this = this;

    function tmpLoad() {
        _this._drawImage(this);
    }

    img.onload = tmpLoad;

    img.src = uri;
};

/**
 * @description 创建Canvas将图片画至其中，并获得压缩后的文件
 * @param {Object}
 *            img 图片文件
 * @param {Number}
 *            width 图片最大宽度
 * @param {Number}
 *            height 图片最大高度
 * @param {Function}
 *            callback 回调函数，参数为图片base64编码 return {Object} 返回压缩后的图片
 */
UploadPic.prototype._drawImage = function(img, callback) {
    this.sw = img.width;
    this.sh = img.height;
    this.tw = img.width;
    this.th = img.height;

    this.scale = (this.tw / this.th).toFixed(2);

    if (this.sw > this.maxWidth) {
        this.sw = this.maxWidth;
        this.sh = Math.round(this.sw / this.scale);
    }

    if (this.sh > this.maxHeight) {
        this.sh = this.maxHeight;
        this.sw = Math.round(this.sh * this.scale);
    }

    this.canvas = document.createElement('canvas');
    var ctx = this.canvas.getContext('2d');

    this.canvas.width = this.sw;
    this.canvas.height = this.sh;

    ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, this.sw, this.sh);

    this.callback(this.canvas.toDataURL(this.type));

    ctx.clearRect(0, 0, this.tw, this.th);
    this.canvas.width = 0;
    this.canvas.height = 0;
    this.canvas = null;
};

function writeJson2() {
	var stu_img_idPic1 = localStorage.getItem("stu_img_idPic1");
	var stu_img_suffix_idPic1 = localStorage.getItem("stu_img_suffix_idPic1");
	if (!!stu_img_idPic1 && stu_img_idPic1 != "") {
		$("#idPic1").hide();
		$("#preview-idPic1").show();
		$("#imgidPic1").attr("src", stu_img_suffix_idPic1 +"base64,"+stu_img_idPic1);
	}
	
	var stu_img_idPic2 = localStorage.getItem("stu_img_idPic2");
	var stu_img_suffix_idPic2 = localStorage.getItem("stu_img_suffix_idPic2");
	if (!!stu_img_idPic2 && stu_img_idPic2 != "") {
		$("#idPic2").hide();
		$("#preview-idPic2").show();
		$("#imgidPic2").attr("src", stu_img_suffix_idPic2 +"base64,"+stu_img_idPic2);
	}
	
	var stu_img_idPic3 = localStorage.getItem("stu_img_idPic3");
	var stu_img_suffix_idPic3 = localStorage.getItem("stu_img_suffix_idPic3");
	if (!!stu_img_idPic3 && stu_img_idPic3 != "") {
		$("#idPic3").hide();
		$("#preview-idPic3").show();
		$("#imgidPic3").attr("src", stu_img_suffix_idPic3 +"base64,"+stu_img_idPic3);
	}
	
	var stu_img_idPic4 = localStorage.getItem("stu_img_idPic4");
	var stu_img_suffix_idPic4 = localStorage.getItem("stu_img_suffix_idPic4");
	if (!!stu_img_idPic4 && stu_img_idPic4 != "") {
		$("#idPic4").hide();
		$("#preview-idPic4").show();
		$("#imgidPic4").attr("src", stu_img_suffix_idPic4 +"base64,"+stu_img_idPic4);
	}
	
		var agencyJson =JSON.parse(localStorage.getItem('agencyJson'))||{};
		console.log(agencyJson);
		if(agencyJson.agencyName){//
			$('.agencyName').val(agencyJson.agencyName);    //代理人姓名
	    	$('.agencyAddress').val(agencyJson.agencyAddress);//代理人地址
	    	$('.agencyPhone').val(agencyJson.agencyPhone);//代理人电话
	    	$('.agencyRelationship').val(agencyJson.agencyRelationship);//与代办人关系
		}
}

$(function (){
	writeJson2();
    //下一步
    $(".cs-btn-next").click(function () {
    	var _stu_img_idPic1 = localStorage.getItem("stu_img_idPic1");
    	if (!_stu_img_idPic1 || _stu_img_idPic1 == "") {
    		alert("请上传个人照片");
    		return false;
    	}
    	
    	var _stu_img_idPic2 = localStorage.getItem("stu_img_idPic2");
    	if (!_stu_img_idPic2 || _stu_img_idPic2 == "") {
    		alert("请上传身份证正面");
    		return false;
    	}
    	
    	
    	var _stu_img_idPic3 = localStorage.getItem("stu_img_idPic3");
    	if (!_stu_img_idPic3 || _stu_img_idPic3 == "") {
    		alert("请上传身份证背面");
    		return false;
    	}
    	
    	
    	//window.location.href = "info_edit3.html";
    	
    	/* var _stu_img_idPic4 = localStorage.getItem("stu_img_idPic4");
    	if (!_stu_img_idPic4 || _stu_img_idPic4 == "") {
    		alert("请上传学生证照片");
    		return false;
    	} */
    	var agencyJson = {};
    	var agencyName = $('.agencyName').val();    //代理人姓名
    	if(!$.trim(agencyName)){//如果没有
    		
    	}
    	var agencyAddress = $('.agencyAddress').val();//代理人地址
    	var agencyPhone = $('.agencyPhone').val();//代理人电话
    	var agencyRelationship = $('.agencyRelationship').val();//与代办人关系
    	agencyJson.agencyName = agencyName;
    	agencyJson.agencyAddress = agencyAddress;
    	agencyJson.agencyPhone = agencyPhone;
    	agencyJson.agencyRelationship = agencyRelationship;
    	localStorage.setItem('agencyJson',JSON.stringify(agencyJson));
    	window.location.href = "add_step3.html?identifid="+_identifid;
    });
    
    $(".css-addimg-bt").click(function () {
        $(this).parent().find("input")[0].click();
    });
    $(".pre-img").click(function () {
        $(this).parent().find("input")[0].click();
    });
})

</script>
</body>
</html>